@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}



@model IEnumerable<Sensore.Models.PressureMatrix>

@{
    var latestFrame = Model.LastOrDefault();
}

<h2>Real-Time Pressure Distribution</h2>

<!-- ===== Metric Cards Section ===== -->
<div class="metrics-grid">
    <div class="metric-card purple">
        <div class="label">Peak Pressure Index</div>
        <div class="value">@latestFrame?.PeakPressureIndex.ToString("0.00")</div>
        <div class="subtext">Target: &lt; 1.5</div>
    </div>

    <div class="metric-card blue">
        <div class="label">Contact Area</div>
        <div class="value">@latestFrame?.ContactAreaPercent.ToString("0")%</div>
        <div class="subtext">Optimal: 60–80%</div>
    </div>

    <div class="metric-card green">
        <div class="label">Average Pressure</div>
        <div class="value">@latestFrame?.AveragePressure.ToString("0") mmHg</div>
        <div class="subtext">Safe: &lt; 60</div>
    </div>

    <div class="metric-card orange">
        <div class="label">Distribution Score</div>
        <div class="value">@latestFrame?.DistributionScore.ToString("0") / 100</div>
        <div class="subtext">Lower is better</div>
    </div>
</div>

<!-- ===== Color Legend Section ===== -->
<div class="legend-card">
    <h4>Real-Time Pressure Color Guide</h4>
    <div class="legend-items">
        <span class="legend blue"></span> Blue = Low Pressure
        <span class="legend yellow"></span> Yellow = Medium Pressure
        <span class="legend red"></span> Red = High Pressure
    </div>
    <p class="legend-note">Chair sensor detecting pressure on buttocks and thighs</p>
</div>

<!-- ====== Heatmap + Healthy Tips + Comments ====== -->
<div class="distribution-grid">
    <div class="left-panel">
        <h3>Pressure Distribution Heatmap</h3>
        <canvas id="heatmapCanvas" width="512" height="512"></canvas>
    </div>

    <div class="right-panel">
        <div class="healthy-tips">
            <h4>✅ Simple Steps to Stay Healthy</h4>
            <ul>
                <li><strong>Move every 30 minutes</strong><br />Set a timer on your phone if it helps!</li>
                <li><strong>Use cushions for red areas</strong><br />Special cushions help spread pressure better.</li>
                <li><strong>Drink plenty of water</strong><br />Healthy, hydrated skin is stronger.</li>
                <li><strong>Talk to your care team</strong><br />If red zones persist, reach out for help.</li>
            </ul>
        </div>

        <!-- 🗨️ Comments Section (Simplified Chat Box) -->
        <div class="comments-section">
            <h3>Comments & Feedback</h3>
            <p>Share your thoughts with your clinician below:</p>

            <div class="comments-actions">
                <button class="btn-outline" id="showCommentsBtn">💬 Show Comments</button>
                <button class="btn-primary" id="addCommentBtn">➕ Add Comment</button>
            </div>

            <div id="commentsContainer" style="display:none; margin-top:1rem;">
                <div class="comment-card">
                    <p><strong>Clinician:</strong> Pressure on right side slightly high — try repositioning.</p>
                    <span class="timestamp">🕒 09:15 AM</span>
                </div>
                <div class="comment-card">
                    <p><strong>You:</strong> Adjusted posture, feels better now ✅</p>
                    <span class="timestamp">🕒 10:00 AM</span>
                </div>
            </div>
        </div>
    </div>
</div>

@{
    // Convert pressure data to JSON for canvas rendering
    var jsonFrames = System.Text.Json.JsonSerializer.Serialize(
        Model.Select(f =>
            Enumerable.Range(0, f.Matrix.GetLength(0))
                .Select(i => Enumerable.Range(0, f.Matrix.GetLength(1))
                    .Select(j => f.Matrix[i, j])
                    .ToArray())
                .ToArray()
        )
    );
}

<script>
    // 🎨 Heatmap rendering
    const frames = @Html.Raw(jsonFrames);
    const canvas = document.getElementById('heatmapCanvas');
    const ctx = canvas.getContext('2d');
    const size = 32;
    const cell = canvas.width / size;

    function drawFrame(matrix) {
        for (let i = 0; i < size; i++) {
            for (let j = 0; j < size; j++) {
                const pressure = matrix[i][j];
                ctx.fillStyle = `rgb(${pressure}, 0, ${255 - pressure})`;
                ctx.fillRect(j * cell, i * cell, cell, cell);
            }
        }
    }

    let index = 0;
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawFrame(frames[index]);
        index = (index + 1) % frames.length;
        setTimeout(animate, 200);
    }
    animate();
</script>

<!-- 💬 Simple JavaScript Comment System -->
<script>
    const showCommentsBtn = document.getElementById("showCommentsBtn");
    const addCommentBtn = document.getElementById("addCommentBtn");
    const commentsContainer = document.getElementById("commentsContainer");

    showCommentsBtn.addEventListener("click", () => {
        commentsContainer.style.display =
            commentsContainer.style.display === "none" ? "block" : "none";
    });

    addCommentBtn.addEventListener("click", async () => {
        const text = prompt("Enter your comment:");
        if (!text) return;

        // 🕒 capture current timestamp
        const timestamp = new Date().toISOString();

        // build new comment card immediately for user feedback
        const card = document.createElement("div");
        card.className = "comment-card";
        card.innerHTML = `
            <p><strong>You:</strong> ${text}</p>
            <span class="timestamp">🕒 ${new Date().toLocaleString()}</span>
        `;
        commentsContainer.appendChild(card);
        commentsContainer.style.display = "block";

        // send to backend for persistence
        try {
            const res = await fetch("/Comments/Add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    FrameTimestamp: timestamp,
                    Text: text,
                    Author: "Patient"
                })
            });

            if (!res.ok) {
                console.error(await res.text());
                alert("⚠️ Couldn't save comment to server, but it shows locally.");
            }
        } catch (err) {
            console.error(err);
            alert("⚠️ Network error saving comment.");
        }
    });
</script>


<!-- ===== Styling ===== -->
<style>
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0 2rem;
    }

    .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.2rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        text-align: center;
    }

        .metric-card .label {
            font-weight: 500;
            color: #444;
            margin-bottom: 0.3rem;
        }

        .metric-card .value {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .metric-card.purple .value {
            color: #8b5cf6;
        }

        .metric-card.blue .value {
            color: #3b82f6;
        }

        .metric-card.green .value {
            color: #22c55e;
        }

        .metric-card.orange .value {
            color: #f97316;
        }

    .legend-card {
        background: #eef3ff;
        padding: 1rem;
        border-radius: 1rem;
        margin-bottom: 1.5rem;
    }

    .legend-items {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .legend {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 5px;
    }

        .legend.blue {
            background: #3b82f6;
        }

        .legend.yellow {
            background: #facc15;
        }

        .legend.red {
            background: #ef4444;
        }

    .distribution-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        align-items: start;
    }

    .healthy-tips {
        background: #ecfdf5;
        border: 1px solid #a7f3d0;
        border-radius: 1rem;
        padding: 1.5rem;
    }

    .comments-section {
        background: #fff;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .comments-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.8rem;
    }

    .btn-primary, .btn-outline {
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
        border: none;
    }

    .btn-outline {
        border: 1px solid #ccc;
        background: white;
    }

    .comment-card {
        background: #f9fafb;
        border-left: 4px solid #3b82f6;
        padding: 0.8rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.6rem;
    }

    .timestamp {
        font-size: 0.8rem;
        color: #777;
        margin-top: 0.3rem;
        display: block;
    }
</style>
